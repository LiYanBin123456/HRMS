<!DOCTYPE html>
<html class="x-admin-sm">

<head>
    <meta charset="UTF-8">
    <title>派遣单位详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8" />
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/xadmin.css">
    <script type="text/javascript" src="../layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/xadmin.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .layui-form-label {
            display: inline-block;
            width: 100px;
            text-align: left;
        }
    </style>
</head>
<body>
<div class="layui-tab layui-tab-brief" lay-filter="tab_dispatch">
    <ul class="layui-tab-title">
        <li class="layui-this">基本信息</li>
        <li lay-id="element_finance" >财务信息</li>
        <li lay-id="element_add" >账号</li>
        <li lay-id="element_permit" >业务</li>
    </ul>
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
            <form lay-filter="form_dispatch" class="layui-form">
                <input type='hidden' name='id'/>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>客户名称</label>
                        <div class="layui-input-inline">
                            <input type="text"  name="name"   placeholder="" autocomplete="off" class="layui-input"></div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label">
                            <span ></span>简称</label>
                        <div class="layui-input-inline">
                            <input type="text"  name="nickname"  placeholder="" autocomplete="off" class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>联系人</label>
                        <div class="layui-input-inline">
                            <input type="text"  name="contact"   placeholder="" autocomplete="off" class="layui-input"></div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>联系电话</label>
                        <div class="layui-input-inline">
                            <input type="text"   name="phone"  placeholder=""  autocomplete="off" class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>地址</label>
                        <div class="layui-input-inline">
                            <input type="text"  name="address"  placeholder="" autocomplete="off" class="layui-input"></div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>微信号</label>
                        <div class="layui-input-inline">
                            <input type="text"  name="wx"  placeholder="" autocomplete="off" class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>QQ号</label>
                        <div class="layui-input-inline">
                            <input type="text"  name="qq"  placeholder="" autocomplete="off" class="layui-input"></div>
                    </div>
                    <div class="layui-inline">
                        <label  class="layui-form-label">
                            <span class="x-red">*</span>邮箱</label>
                        <div class="layui-input-inline">
                            <input type="text"  name="mail"   placeholder="" autocomplete="off" class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label  class="layui-form-label">
                        <span class="x-red">*</span>单位简介</label>
                    <div class="layui-input-block">
                        <textarea name="intro" placeholder="" class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-form-item" style="text-align: center">
                    <button type="submit" lay-submit lay-filter="submit_dispatch"  class="layui-btn" >保存</button>
                    <button class="layui-btn" onclick="cancel()" >取消</button>
                </div>
            </form>
        </div>
        <div class="layui-tab-item" >
            <form lay-filter="form_finance" class="layui-form">
                <input type='hidden' name='id'/>
                <input type='hidden' name='cid'/>
                <div class="layui-form-item">
                    <label  class="layui-form-label">
                        <span class="x-red">*</span>信用代码</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="code" required=""  placeholder="" autocomplete="off" class="layui-input"></div>
                </div>
                <div class="layui-form-item">
                    <label  class="layui-form-label">
                        <span class="x-red">*</span>开户行</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="bank" required=""  placeholder="" autocomplete="off" class="layui-input"></div>
                </div>
                <div class="layui-form-item">
                    <label  class="layui-form-label">
                        <span class="x-red">*</span>银行账户</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="cardNo" required=""  placeholder="" autocomplete="off" class="layui-input"></div>
                </div>
                <div class="layui-form-item">
                    <label  class="layui-form-label">
                        <span class="x-red">*</span>联系人</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="contact" required="" placeholder="" autocomplete="off" class="layui-input"></div>
                </div>
                <div class="layui-form-item">
                    <label  class="layui-form-label">
                        <span class="x-red">*</span>联系电话</label>
                    <div class="layui-input-inline">
                        <input type="text"   name="phone" required="" placeholder=""  autocomplete="off" class="layui-input"></div>
                </div>
                <div class="layui-form-item" style="text-align: center" >
                    <button type="submit" lay-submit lay-filter="submit_finance" class="layui-btn" >保存</button>
                    <button  class="layui-btn" onclick="cancel()" >取消</button>
                </div>
            </form>
        </div>
        <div class="layui-tab-item" >
            <form lay-filter="form_account" class="layui-form">
                <input type='hidden' name='id'/>
                <input type='hidden' name='cid'/>
                <div class="layui-form-item">
                    <label  class="layui-form-label">
                        <span class="x-red">*</span>昵称</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="nickname" required=""  placeholder="" autocomplete="off" class="layui-input"></div>
                </div>
                <div class="layui-form-item">
                    <label  class="layui-form-label">
                        <span class="x-red">*</span>登录账号</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="username" required=""  placeholder="" autocomplete="off" class="layui-input"></div>
                </div>
                <div class="layui-form-item">
                    <label  class="layui-form-label">
                        <span class="x-red">*</span>初始密码</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="password" required=""  placeholder="" autocomplete="off" class="layui-input"></div>
                </div>
                <div class="layui-form-item" style="text-align: center" >
                    <button type="submit" lay-submit lay-filter="submit_user" class="layui-btn" >保存</button>
                    <button  class="layui-btn" onclick="cancel()" >取消</button>
                </div>
            </form>
        </div>
        <div class="layui-tab-item dialog-content">
            <form lay-filter="form_permission" class="layui-form">
                <fieldset class="layui-elem-field layui-field-title">
                    <legend>角色</legend>
                </fieldset>
                <form lay-filter="form_role" class="layui-form">
                    <input type="radio" lay-filter="role" name="role" value="0,0" title="客服" checked>
                    <input type="radio" lay-filter="role" name="role" value="524288,0" title="管理员">
                </form>
                <fieldset class="layui-elem-field layui-field-title">
                    <legend>权限分配</legend>
                </fieldset>
                <div id="permission"></div>
                <button type="button" class="layui-btn" onclick="savePermission()">保存</button>
            </form>
        </div>
    </div>
</div>
</body>
<script src="../js/jquery.min.js"></script>
<script src="../js/jquery.params.js"></script>
<script src="../js/interface.js"></script>
<script src="../js/fieldSet.js"></script>
<script src="../js/menu.js"></script>
<script>
    var form;//表单对象
    var editer;
    var element;
    var dispatch;
    var finance;
    var account={role:1,rid:0};
    var tree;
    loadLayuiModule();

    function loadLayuiModule() {
        layui.use(['form', 'layedit','element','tree'], function () {
            form = layui.form;
            layedit = layui.layedit;
            element = layui.element;
            editer = layedit.build('content'); //建立编辑器
            tree = layui.tree;
            var inst1 = tree.render({
                elem: '#permission',  //绑定元素
                id:'tree_permission',
                showCheckbox:true,
                data: menuItems_dispatch
            });
            initPage();
            getDispatch();
        });
    }

    function initPage() {
        element.on('tab(tab_dispatch)', function(data) {
            switch (data.index) {
                case 0:
                    getDispatch();//获取合同基础信息
                    break;
                case 1:
                    getFinance();//获取合同服务项目
                    break;
                case 2:
                    getAccount();//获取账号信息
                    break;
                case 3://业务
                    initData();
                    break;

            }
        });
        form.on('submit(submit_dispatch)', function(data){
            saveDispatch(data.field);
            return false;
        });
        form.on('submit(submit_finance)', function(data){
            saveFinance(data.field);
            return false;
        });
        form.on('submit(submit_user)', function(data){
            saveAccount(data.field);
            return false;
        });
    }

    function getDispatch() {
        var id = $.query.get("id");
        if(id){
            webInterface.client.get({id:id,category:0,success:function (result) {
                dispatch = result.data;
                form.val('form_dispatch', dispatch);
                layedit.setContent(editer, dispatch.content, false);
            }});
        }
    }

    function getFinance() {
        if(dispatch && dispatch.id) {
            webInterface.client.getFinance({id:dispatch.id,category:0, success:function (result) {
                if(result.data) {
                    finance = result.data;
                    form.val('form_finance', finance);
                }
            }});
        }
    }
    function saveDispatch() {
        var data = form.val('form_dispatch');
        if(data.name == ""){
            layer.msg("请填写客户名称信息");
            return;
        }
        if(data.contact == ""){
            layer.msg("请填写联系人信息");
            return;
        }
        if(data.phone == ""){
            layer.msg("请填写联系电话信息");
            return;
        }
        if(data.address == ""){
            layer.msg("请填写地址信息");
            return;
        }
        if(data.wx == ""){
            layer.msg("请填写微信信息");
            return;
        }
        if(data.qq == ""){
            layer.msg("请填写QQ信息");
            return;
        }
        if(data.mail == ""){
            layer.msg("请填写邮箱信息");
            return;
        }
        if (dispatch) {
            webInterface.client.update({client:data,category:0,success:function (result) {
                layer.msg("修改成功");
                var index = parent.layer.getFrameIndex(window.name);
                parent.getDispatchs(true);//刷新父页数据
                parent.layer.close(index);
                //window.parent.location.reload();
            }});
        } else {
            webInterface.client.insert({client:data,category:0, success:function (result) {
                dispatch.id = result.extra;
                element.tabChange('tab_dispatch', 'element_finance');
                layer.alert("基础信息保存成功，请完善财务信息", {icon: 20});
                parent.getDispatchs(true);//刷新父页数据
            }});
        }
        dispatch = data;
    }
    function saveFinance() {
        if(!dispatch || !dispatch.id ){
            layer.msg("请先保存派遣单位基本信息");
            return;
        }
        var data = form.val('form_finance');
        if(data.code == ""){
            layer.msg("请填写信用代码信息");
            return;
        }
        if(data.bank == ""){
            layer.msg("请填写开户行信息");
            return;
        }
        if(data.cardNo == ""){
            layer.msg("请填写银行账户信息");
            return;
        }
        if(data.contact == ""){
            layer.msg("请填写联系人信息");
            return;
        }
        if(data.phone == ""){
            layer.msg("请填写联系电话信息");
            return;
        }
        if(data.address == ""){
            layer.msg("请填写简介信息");
            return;
        }
        data.cid = dispatch.id;
        if (finance) {
            webInterface.client.updateFinance({finance:data,success:function (result) {
                layer.msg("修改成功");
            }});
        } else {
            webInterface.client.insertFinance({finance:data, success:function (result) {
                layer.msg("添加成功");
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
                window.parent.location.reload();
            }});
        }
        finance = data;
    }

    function getAccount() {
        if(dispatch && dispatch.id) {
            account.role=1;
            account.rid=dispatch.id;
            //获取权限是派遣方管理员且rid是派遣方的id的管理员
            webInterface.account.getAdmin({account:account, success:function (result) {
                if(result.data) {
                    account =result.data;
                    form.val('form_account', account);
                }
            }});
        }
    }
    function saveAccount() {
        if(!dispatch || !dispatch.id ){
            layer.msg("请先保存派遣单位基本信息");
            return;
        }
        var data = form.val('form_account');
        if(data.username == ""){
            layer.msg("请填写账号");
            return;
        }
        if(data.password == ""){
            layer.msg("请填写密码");
            return;
        }
        data.cid = dispatch.id;
        if (account) {
            webInterface.account.update({account:data,success:function (result) {
                layer.msg("修改成功");
            }});
        } else {
            data.role=1;
            data.rid=dispatch.id;
            webInterface.account.insertAdmin({account:data, success:function (result) {
                layer.msg("添加成功");
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
                window.parent.location.reload();
            }});
        }
        account = data;
    }

    function cancel(){
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    }


    function initData() {
        account = JSON.parse($.query.get("account"));
        var permission = account.permissionString;
        if(bit_test(permission,"524288,0")){
            form.val('form_role',{role:"524288,0"});
        }else{
            form.val('form_role',{role:"0,0"});
        }

        var checkeds = [];
        for(var i in menuItems_dispatch){
            var item = menuItems_dispatch[i];
            var children = item.children;
            if(children){
                for(var j in children) {
                    var child = children[j];
                    if(bit_test(child.id ,permission)){
                        checkeds.push(child.id);
                    }
                }
            }else{
                if(bit_test(item.id ,permission)){
                    checkeds.push(item.id);
                }
            }
        }
        tree.setChecked("tree_permission",checkeds);
    }

    function savePermission() {
        var items = tree.getChecked('tree_permission');
        var permit = 0;
        for(var i in items){
            var subItems = items[i].children
            if(subItems){
                for(var j in subItems){
                    permit += calc(subItems[j].id);
                }
            }else {
                permit += calc(items[i].id);
            }
        }
        var data = form.val('form_role');
        permit += calc(data.role);

        webInterface.account.permit({id:account.id,permit:permit,success:function (result) {
            layer.msg("权限分配成功！");// 获得frame索引
            var index = parent.layer.getFrameIndex(window.name);
            //关闭当前frame
            parent.layer.close(index);
            //修改成功后刷新父界面
            window.parent.location.reload();
        }});
    }

</script>

</html>