<!DOCTYPE html>
<html class="x-admin-sm">

<head>
    <meta charset="UTF-8">
    <title>添加客户</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi"/>
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/xadmin.css">
    <script type="text/javascript" src="../lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/xadmin.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .salary_priview {
            border: 1px solid grey;
        }

        [name=salary_item_defined]:after {
            content: "×";
            position: relative;
            left: 5px;
            top: -12px;
            color: red;
        }

        .salary_item {
            padding: 10px;
            margin: 5px;
        }

    </style>
</head>
<body>
<div class="layui-tab layui-tab-brief" lay-filter="tab_info">
    <ul class="layui-tab-title">
        <li class="layui-this" lay-id="base">基础信息</li>
        <li lay-id="finance">财务信息</li>
        <li lay-id="salary_define">工资定义</li>
    </ul>
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
            <form lay-filter="form_cooperation" class="layui-form">
                <input type='hidden' name='id'/>
                <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>客户名称</label>
                    <div class="layui-input-inline">
                        <input type="text" name="name" required="" autocomplete="off" class="layui-input"></div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>客户性质</label>
                    <div class="layui-input-inline">
                        <select name="category" lay-verify="required">
                            <option value=""></option>
                            <option value="0">政府部门</option>
                            <option value="1">事业单位</option>
                            <option value="2">人才市场</option>
                            <option value="3">学校</option>
                            <option value="4">内资企业</option>
                            <option value="5">外资企业</option>
                            <option value="6">港澳台企业</option>
                            <option value="7">内资工厂</option>
                            <option value="8">外资工厂</option>
                            <option value="9">港澳台工厂</option>
                            <option value="10">其他</option>
                        </select>
                    </div>
                </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>联系人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="contact" required=""  autocomplete="off"
                               class="layui-input">
                    </div>
                    </div>
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>联系电话</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="phone"
                               required="" autocomplete="off" class="layui-input"></div>
                     </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>微信号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="wx" required="" autocomplete="off" class="layui-input"></div>
                     </div>
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>QQ号</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="qq" required=""
                               autocomplete="off" class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>地址</label>
                    <div class="layui-input-inline">
                        <input type="text" name="address" required="" autocomplete="off" class="layui-input"></div>
                     </div>
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>邮箱</label>
                    <div class="layui-input-inline">
                        <input type="text" name="mail" required="" autocomplete="off" class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>客户简介</label>
                    <div class="layui-input-block">
                        <textarea name="intro" placeholder="请输入内容" class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-form-item" style="text-align: center" >
                    <button lay-submit lay-filter="submit_cooperation" class="layui-btn " >保存</button>
                    <button class="layui-btn" onclick="cancel()" >取消</button>
                </div>
            </form>
        </div>
        <div class="layui-tab-item">
            <form lay-filter="form_finance" class="layui-form">
                <input type='hidden' name='id'/>
                <input type='hidden' name='cid'/>
                <input type='hidden' name='type' value="1"/>
                <div class="layui-form-item">
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>统一社会信用代码</label>
                    <div class="layui-input-inline">
                        <input type="text" name="code" required="" autocomplete="off"
                               class="layui-input"></div>
                     </div>
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>开户行</label>
                    <div class="layui-input-inline">
                        <input type="text" name="bank" required=""  autocomplete="off"
                               class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>银行账户</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="cardNo"
                               required="" autocomplete="off" class="layui-input"></div>
                     </div>
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>联系人</label>
                    <div class="layui-input-inline">
                        <input type="text" name="contact" required=""  autocomplete="off"
                               class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>联系电话</label>
                    <div class="layui-input-inline">
                        <input type="text"  name="phone"
                               required="" autocomplete="off" class="layui-input"></div>
                     </div>
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>公司地址</label>
                    <div class="layui-input-inline">
                        <input type="text" name="address" required="" autocomplete="off" class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>大额行号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="bankNo" required=""  autocomplete="off"
                               class="layui-input">
                    </div>
                    </div>
                    <div class="layui-inline">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>公司余额</label>
                    <div class="layui-input-inline">
                        <input type="text" name="balance" required=""  autocomplete="off"
                               class="layui-input"></div>
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">
                        <span class="x-red">*</span>备注</label>
                    <div class="layui-input-block">
                        <textarea name="intro" placeholder="请输入内容" class="layui-textarea"></textarea>
                    </div>
                </div>
                <div class="layui-form-item" style="text-align: center">
                    <button type="submit" lay-submit lay-filter="submit_finance" class="layui-btn" >保存</button>
                    <button class="layui-btn" onclick="cancel()" >取消</button>
                </div>
            </form>
        </div>
        <div class="layui-tab-item">
            <fieldset class="layui-elem-field layui-field-title">
                <legend>工资表预览</legend>
            </fieldset>
            <div id="table_contain"></div>
            <fieldset class="layui-elem-field layui-field-title">
                <legend>自定义工资字段</legend>
            </fieldset>
            <blockquote class="layui-elem-quote">红色的是固定项，黄色的是自定义加项，绿色的是自定义减项。固定向不能变更，自定义项可以单击“+”进行添加自定义字段（最多20个），单击自定义字段可以删除</blockquote>
            <div id="template" class="layui-hide">
                <span name="salary_item_fixed" class="layui-badge salary_item">固定字段</span>
                <span name="salary_item_defined0" class="layui-badge layui-bg-orange salary_item">自定义加项</span>
                <span name="salary_item_defined1" class="layui-badge layui-bg-green salary_item">自定义减项</span>
            </div>
            <div id="salary_items">
                <span id="btn_append" class="layui-badge layui-bg-orange salary_item" onclick="appendSalaryItem(0)">&emsp;&emsp;+&emsp;&emsp;</span>
                <span class="layui-badge layui-bg-green salary_item" onclick="appendSalaryItem(1)">&emsp;&emsp;+&emsp;&emsp;</span>
            </div>
            <div class="layui-input-block">
                <button class="layui-btn" onclick="saveSalaryDefine()">保存</button>
                <button class="layui-btn" onclick="previewSalaryDefine()">预览</button>
            </div>
        </div>
    </div>
</div>
</body>
<script src="../js/jquery.min.js"></script>
<script src="../js/jquery.params.js"></script>
<script src="../js/interface.js"></script>
<script>
    var form;//表单对象
    var table;
    var layer;
    var editer;
    var element;
    var id = $.query.get("id");
    var cooperation;
    var finance;
    var salary_items_fixed = ["基本工资", "个人养老", "个人医疗", "个人失业", "个人大病", "个人公积金","单位养老","单位医疗","单位失业","单位工伤","单位大病","单位生育", "单位公积金", "个税", "应发", "实发"];
    var salary_items_defined;//合作企业自定义工资字段
    var mapSalary;

    loadLayuiModule();

    function loadLayuiModule() {
        layui.use(['form', 'table', 'layedit', 'layer', 'element', 'jquery'], function () {
            form = layui.form;
            table = layui.table;
            element = layui.element;
            layer = layui.layer;
            layedit = layui.layedit;
            editer = layedit.build('content'); //建立编辑器
            //监听Tab切换，以改变地址hash值
            element.on('tab(tab_info)', function () {
                var id = this.getAttribute('lay-id');
                switch (id) {
                    case "base":
                        getCooperation();
                        break;
                    case "finance":
                        getFinance();
                        break;
                    case "salary_define":
                        initSalayDefine();
                        break;
                }
            });
            initPage();
            getCooperation();
        });
    }

    function initPage() {
        form.on('submit(submit_cooperation)', function(data){
            saveCooperation(data.field);
            element.tabChange('tab_info', 'finance');
            return false;
        });
        form.on('submit(submit_finance)', function(data){
            saveFinance(data.field);
            element.tabChange('tab_info', 'salary_define');
            return false;
        });
    }
    function getCooperation() {
        if(id) {
            iClient.get(id, 1, function (result) {
                cooperation = result.data;
                form.val('form_cooperation', cooperation);
                layedit.setContent(editer, cooperation.content, false);
            });
        }
    }
    function getFinance() {
        if(cooperation && cooperation.id) {
            iClient.getFinance(cooperation.id, 1, function (result) {
                if(result.data) {
                    finance = result.data;
                    form.val('form_finance', finance);
                }
            });
        }
    }

    function initSalayDefine() {
        //如果已经有基本信息就忽略
        if (salary_items_defined && salary_items_defined.length > 0) {
            return;
        }
        //显示固定项
        for (var i in salary_items_fixed) {
            var item = salary_items_fixed[i];
            var node = $("#template [name=salary_item_fixed]").clone();
            node.text(item);
            $("#btn_append").before(node);
        }

        //显示自定义项
        //此处应该从后台获取,以分号分隔自定义项，以逗号分隔名称和类型（0-加项；1-减项）
        iClient.getLastSalaryDefine(id,function (result) {
            mapSalary = result.data;
            if(mapSalary && mapSalary.items) {
                salary_items_defined = mapSalary.items.split(";");
                for (var i in salary_items_defined) {
                    var item = salary_items_defined[i];
                    var v = item.split(',');
                    var node = v[1] == '0' ? $("#template [name=salary_item_defined0]").clone() : $("#template [name=salary_item_defined1]").clone();
                    node.text(v[0]);
                    node.click(removeSalaryItem);
                    $("#btn_append").before(node);
                }
            }else{
                mapSalary = {};
                salary_items_defined = [];
            }
        });

    }

    //添加自定义字段
    function appendSalaryItem(type) {
        layer.prompt({
            formType: 2, value: '', title: '请输入字段名（不超过8个字符）', area: ['100px', '30px'] //自定义文本域宽高
        }, function (value, index, elem) {
            if (salary_items_defined.length >= 20) {
                layer.msg('最多只能子定义20个字段');
            } else {
                salary_items_defined.push(value+","+type);
                var node = type==0?$("#template [name=salary_item_defined0]").clone():$("#template [name=salary_item_defined1]").clone();
                node.text(value);
                node.click(removeSalaryItem);
                $("#btn_append").before(node);
            }
            layer.close(index);
        });
    }

    //删除自定义字段
    function removeSalaryItem() {
        var that = this;
        var item = $(that).text();
        var msg = '确定要删除自定义字段[' + item + ']?';
        layer.confirm(msg, function (index) {
            that.remove();//移除元素
            //从自定义字段集合中移除
            for (var i in salary_items_defined) {
                if (salary_items_defined[i].split(",")[0] == item) {
                    salary_items_defined.splice(i, 1);
                    break;
                }
            }
            layer.close(index);
        });
    }

    //保存工资定义
    function saveSalaryDefine() {
        if(!cooperation || !cooperation.id ){
            layer.msg("请先保存合作单位基本信息");
            return;
        }
        var items = salary_items_defined.join(";");
        if(items == mapSalary.items){
            layer.msg("未改变，无需保存");
            return;
        }


        mapSalary.items = items;
        mapSalary.cid = cooperation.id;
        iClient.insertSalaryDefine(mapSalary, function (result) {
            layer.msg("保存成功");
        });
    }

    //预览工资定义
    function previewSalaryDefine() {
        $("#table_contain").empty();
        $("#table_contain").append('<table id="preview_salary" class="layui-table"></table>');
        var cols = generateColumns();
        var data = [];
        for (var i in cols) {
            var d = {i: 0};
            data.push(d);
        }
        //初始化数据表格
        table.render({
            elem: '#preview_salary',
            cols: cols,
            data: data
        });

        function generateColumns() {
            var columns = [];
            for (var i in salary_items_fixed) {
                var item = salary_items_fixed[i];
                var field = {field: i, title: item, width: 15 * item.length + 30};
                columns.push(field);
            }
            for (var i in salary_items_defined) {
                var item = salary_items_defined[i];
                var field = {field: i, title: item, width: 15 * item.length + 30};
                columns.push(field);
            }
            return [columns];
        }
    }

    function saveCooperation() {
        var data = form.val('form_cooperation');
        if(cooperation) {
            iClient.update(data,1,function (result){
                layer.msg("修改成功");
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
            });
        }else{
            iClient.insert(data,1,function (result){
                cooperation.id = result.extra;
                finance = {};
                mapSalary = {};
                salary_items_defined = [];
                layer.alert("基础信息保存成功，请完善财务信息", {icon: 20});
            });
        }
        cooperation = data;
    }

    function saveFinance() {
        if(!cooperation || !cooperation.id ){
            layer.msg("请先保存合作单位基本信息");
            return;
        }
        var data = form.val('form_finance');
        data.cid = cooperation.id;
        if(finance) {
            iClient.updateFinance(data,function (result){
                layer.msg("修改成功");
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
            });
        }else{
            iClient.insertFinance(data,function (result){
                layer.alert("财务信息保存成功，请完善自定义工资信息", {icon: 20});
            });
        }
        finance = data;
    }
    function cancel(){
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    }
</script>

</html>
