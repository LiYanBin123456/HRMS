<!DOCTYPE html>
<html class="x-admin-sm">
<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8" />
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/xadmin.css">
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/xadmin.js"></script>
</head>
<body>
    <div class="dialog-content">
        <div id="permission"></div>
        <button type="button" class="layui-btn" onclick="savePermission()">保存</button>
    </div>
</body>
<script src="../js/jquery.min.js"></script>
<script src="../js/jquery.params.js"></script>
<script src="../js/interface.js"></script>
<script src="../js/fieldSet.js"></script>
<script src="../js/menu.js"></script>
<script>
    var id;//账号id
    var tree;

    $(function () {
        loadLayuiModule();
    });

    function loadLayuiModule() {
        layui.use(['tree'], function () {
            tree = layui.tree;
            var inst1 = tree.render({
                elem: '#permission',  //绑定元素
                id:'tree_permission',
                showCheckbox:true,
                data: menuItems_dispatch
            });

            initData();
        });
    }


    function initData() {
        id = $.query.get("id");
        var permission = Number($.query.get("permission"));

        var checkeds = [];
        for(var i in menuItems_dispatch){
            var item = menuItems_dispatch[i];
            var children = item.children;
            if(children){
                for(var j in children) {
                    var child = children[j];
                    if(child.id & permission){
                        checkeds.push(child.id);
                    }
                }
            }else{
                if(item.id & permission){
                    checkeds.push(item.id);
                }
            }
        }
        tree.setChecked("tree_permission",checkeds);
    }

    function savePermission() {
        var checkData = tree.getChecked('tree_permission');
        var permit = 0;
        for(var i in checkData){
            permit += checkData[i].id;
        }
        iAccount.permit(id,permit,function (result) {
            layer.msg("权限分配成功！");// 获得frame索引
            var index = parent.layer.getFrameIndex(window.name);
            //关闭当前frame
            parent.layer.close(index);
            //修改成功后刷新父界面
            window.parent.location.reload();
        });
    }
</script>

</html>